вкл прелюдия;
вкл рейлиб;

конст ЦВЕТ_ЗАДНЕГО_ФОНА := 16%ФФ211816нат;
конст ЦВЕТ_ПЕРЕДНЬЕГО_ФОНА := 16%ФФ957260нат;

конст ШИРИНА_ОКНА := 800;
конст ВЫШИНА_ОКНА := 1000;

конст ЦЕНТР_ОКНА_ИКС := (ШИРИНА_ОКНА как вещ) / 2.0;
конст ЦЕНТР_ОКНА_ИГРЕК := (ВЫШИНА_ОКНА как вещ) / 2.0;

конст ДИАМЕТР_КОЛЬЦА := ШИРИНА_ОКНА - 120;

конст СИЛА_ОТСКОКА := 15.0;
конст СИЛА_ГРАВИТАЦИИ := 0.3;
конст РОСТ_МЯЧЯ_ПРИ_СТОЛКНАВЕНИЙ := 120.0;
конст РОСТ_МЯЧЯ_ПРИ_СТОЛКНАВЕНИЙ_ИНЫХ_МЯЧЕЙ := 80.0;
конст КОЛИЧЕСТВО_МЯЧИКОВ := 6;

конст ПИ := 3.14159265358979323846;

про корень(икс: вещ): вещ внешняя "sqrtf";

структ Мяч нч
  икс: вещ;
  игрек: вещ;

  скорость_икс: вещ;
  скорость_игрек: вещ;

  радиус: вещ;

  площадь: вещ;
кц

про нарисовать_мячик(мячик: Мяч) нч
  нарисовать_круг(мячик.икс как цел, мячик.игрек как цел, (мячик.радиус * 2.0) как цел, ЦВЕТ_ПЕРЕДНЬЕГО_ФОНА);
кц

// про добавить_мяч(мас: массив(КОЛИЧЕСТВО_МЯЧИКОВ, Мяч)


про главная() нч
  // пер номер: нат := 30нат;
  // печать(номер, " Привет, мир\н");
  //
  // для индекс := 0..10 нч
  //   печать("Номер ", индекс, "\н");
  // кц

  пер мячи: массив(КОЛИЧЕСТВО_МЯЧИКОВ, Мяч);
  для индекс := 1..КОЛИЧЕСТВО_МЯЧИКОВ нч
    пер мячик: Мяч;
    мячик.радиус := 5.0;
    мячик.площадь := 100.0;
    мячик.икс := (ШИРИНА_ОКНА как вещ) / 2.0 + 190.0 - (индекс как вещ) * 55.0;
    мячик.игрек := (ВЫШИНА_ОКНА как вещ) / 2.0;
    мячик.скорость_икс := 0.0;
    мячик.скорость_игрек := 0.0;
    мячи(индекс-1) := мячик;
  кц

  открыть_окно(ШИРИНА_ОКНА, ВЫШИНА_ОКНА, адрес("Скачущий мячик"));
  установить_целевую_частоту_кадров(60);

  пока !пора_закрыть_окно() нч
    начать_рисовать();
    очистить_фон(ЦВЕТ_ЗАДНЕГО_ФОНА);

    для индекс := 1..КОЛИЧЕСТВО_МЯЧИКОВ нч
      пер мячик: Мяч := мячи(индекс-1);
      нарисовать_мячик(мячик);
      мячик.икс := мячик.икс + мячик.скорость_икс;
      мячик.игрек := мячик.игрек + мячик.скорость_игрек;

      мячик.скорость_игрек := мячик.скорость_игрек + СИЛА_ГРАВИТАЦИИ;

      пер икс_расс: вещ := ((ШИРИНА_ОКНА как вещ) / 2.0) - (мячик.икс);
      пер игрек_расс: вещ := ((ВЫШИНА_ОКНА как вещ) / 2.0) - (мячик.игрек);
      пер расстояние: вещ := корень(икс_расс * икс_расс + игрек_расс * игрек_расс);

      пер цельевая_глубина: вещ := ((ДИАМЕТР_КОЛЬЦА как вещ) / 2.0) - мячик.радиус;
      // печать(расстояние как цел, " - ", цельевая_глубина как цел, "\н");

      если расстояние +? цельевая_глубина нч
        пер нормализованный_икс: вещ := икс_расс / расстояние;
        пер нормализованный_игрек: вещ := игрек_расс / расстояние;
        пер глубина: вещ := цельевая_глубина - расстояние;
        //печать(глубина как цел, "\н");

        мячик.скорость_икс := нормализованный_икс * СИЛА_ОТСКОКА;//-глубина * 1.6;
        мячик.скорость_игрек := нормализованный_игрек * СИЛА_ОТСКОКА;//-глубина * 1.6;

        мячик.икс := ЦЕНТР_ОКНА_ИКС - нормализованный_икс * цельевая_глубина;
        мячик.игрек := ЦЕНТР_ОКНА_ИГРЕК - нормализованный_игрек * цельевая_глубина;

        мячик.площадь := мячик.площадь + РОСТ_МЯЧЯ_ПРИ_СТОЛКНАВЕНИЙ;

        // икс_расс   := (мячик.икс) - ((ШИРИНА_ОКНА как вещ) / 2.0);
        // игрек_расс := (мячик.игрек) - ((ВЫШИНА_ОКНА как вещ) / 2.0);
        // расстояние := корень(икс_расс * икс_расс + игрек_расс * игрек_расс);
        // нормализованный_икс := икс_расс / расстояние;
        // нормализованный_игрек := игрек_расс / расстояние;
        // глубина := ((ДИАМЕТР_КОЛЬЦА как вещ) / 2.0) - мячик.радиус;
      кц

      если (ДИАМЕТР_КОЛЬЦА как вещ) / 2.0 +? мячик.радиус - 2.0 то мячик.радиус := корень(мячик.площадь / ПИ);
      мячи(индекс-1) := мячик;
    кц

    для икс := 1..КОЛИЧЕСТВО_МЯЧИКОВ нч
      пер мяч_а: Мяч := мячи(икс-1);
      для игрек := 1..КОЛИЧЕСТВО_МЯЧИКОВ нч
        пер мяч_б: Мяч := мячи(игрек-1);

        пер икс_расс: вещ := (мяч_б.икс) - (мяч_а.икс);
        пер игрек_расс: вещ := (мяч_б.игрек) - (мяч_а.игрек);
        пер расстояние: вещ := корень(икс_расс * икс_расс + игрек_расс * игрек_расс);
        
        пер сумма_радиусов: вещ := мяч_б.радиус + мяч_а.радиус;

        если расстояние -? сумма_радиусов и расстояние != 0.0 нч
          пер нормализованный_икс: вещ := икс_расс / расстояние;
          пер нормализованный_игрек: вещ := игрек_расс / расстояние;
          пер глубина: вещ := (сумма_радиусов - расстояние) / 2.0;

          // печать("Столкновение");

          мяч_а.скорость_икс := мяч_а.скорость_икс - (глубина * нормализованный_икс);
          мяч_а.скорость_игрек := мяч_а.скорость_игрек - (глубина * нормализованный_игрек);
          мяч_а.площадь := мяч_а.площадь + РОСТ_МЯЧЯ_ПРИ_СТОЛКНАВЕНИЙ_ИНЫХ_МЯЧЕЙ;

          мяч_б.скорость_икс := мяч_б.скорость_икс + (глубина * нормализованный_икс);
          мяч_б.скорость_игрек := мяч_б.скорость_игрек + (глубина * нормализованный_игрек);
          мяч_б.площадь := мяч_б.площадь + РОСТ_МЯЧЯ_ПРИ_СТОЛКНАВЕНИЙ_ИНЫХ_МЯЧЕЙ;


          мячи(игрек-1) := мяч_б;
          мячи(икс-1) := мяч_а;
        кц
      кц
    кц

    нарисовать_кольцо(ШИРИНА_ОКНА / 2, ВЫШИНА_ОКНА / 2, ДИАМЕТР_КОЛЬЦА, ДИАМЕТР_КОЛЬЦА + 20, ЦВЕТ_ПЕРЕДНЬЕГО_ФОНА);

    // Сука на поддерживает русский, гадкий буржуй
    нарисовать_текст(адрес("Нажмите пробел чтобы добавить мячик"), 120, ВЫШИНА_ОКНА - 40, 25, БЕЛЫЙ);

    закончить_рисовать();
  кц

  закрыть_окно();
кц
